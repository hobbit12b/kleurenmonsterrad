<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <title>3x3 Kleuren Bingo — unieke kaarten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --bg:#f6f7fb; --fg:#222; --paper:#fff; }
    * { box-sizing: border-box; }
    body { margin:0; padding:20px; font-family:system-ui,Arial,sans-serif; background:var(--bg); color:var(--fg); }
    h1 { margin:0 0 12px 0; font-size:22px; }
    .toolbar { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:16px; }
    .toolbar input[type="number"]{ width:80px; padding:8px 10px; border:2px solid var(--fg); border-radius:10px; background:#fff; color:#111; }
    button, select {
      padding:8px 12px; border:0; border-radius:12px; cursor:pointer;
      background:var(--fg); color:#fff; font-size:14px;
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:16px; }
    .card { background:var(--paper); border:4px solid var(--fg); border-radius:16px; padding:12px; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .card h2 { font-size:14px; margin:0; }
    canvas.cardcnv { width:100%; height:auto; background:#fff; border-radius:10px; }
    .row { display:flex; gap:10px; align-items:center; }
    a.dl { text-decoration:none; color:#fff; background:#2d6cdf; padding:6px 10px; border-radius:10px; font-size:13px; }
    label small { font-size:12px; opacity:.75; }
    @media print {
      .toolbar { display:none; }
      body { background:#fff; padding:0; }
      .grid { grid-template-columns:repeat(2, 1fr); gap:0; }
      .card { border:0; page-break-inside:avoid; }
    }
  </style>
</head>
<body>
  <h1>3x3 Kleuren Bingo</h1>
  <div class="toolbar">
    <button id="gen">Genereer kaarten</button>
    <label>Aantal
      <input id="aantal" type="number" min="1" max="50" value="25">
    </label>
    <button id="printBtn">Print</button>
    <label>
      <input type="checkbox" id="labelsToggle">
      Namen in de vakjes <small>(uit)</small>
    </label>
  </div>

  <div id="status" aria-live="polite"></div>
  <div id="grid" class="grid"></div>

  <script>
  // ---------- kleurensets ----------
  const hoofd = ["Bruin","Zilver","Goud","Beige","Turquoise","Zalmroze","Grijs"];
  const extra = ["Wit","Grijs","Zwart","Lichtblauw","Donkerblauw","Roze","Paars","Rood","Lichtgroen","Donkergroen","Geel","Oranje"];
  const alle  = Array.from(new Set([...hoofd, ...extra]));

  const kleurMap = {
    "Bruin":"#8B4513","Zilver":"#C0C0C0","Goud":"#D4AF37","Beige":"#F5F5DC","Turquoise":"#40E0D0","Zalmroze":"#FFA07A","Grijs":"#bdbdbd",
    "Wit":"#ffffff","Zwart":"#000000","Lichtblauw":"#87cefa","Donkerblauw":"#1e3a8a","Roze":"#ff9acb","Paars":"#8b5cf6",
    "Rood":"#ef4444","Lichtgroen":"#86efac","Donkergroen":"#166534","Geel":"#fde047","Oranje":"#fb923c"
  };
  const metallic = new Set(["Goud","Zilver"]);
  const witlijnen = new Set(["Zwart"]); // zwarte krijgt witte lijnen

  // ---------- assets ----------
  const imgMask  = new Image(); imgMask.src  = "monster-mask.png";
  const imgLine  = new Image(); imgLine.src  = "monster-line.png";
  const imgPupil = new Image(); imgPupil.src = "monster-pupillen.png"; // niet gebruikt hier

  let assetsOK = false;
  Promise.all([
    new Promise(r => imgMask.onload  = r),
    new Promise(r => imgLine.onload  = r),
    new Promise(r => imgPupil.onload = r)
  ]).then(() => assetsOK = true);

  // ---------- helpers ----------
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

  // kies k verschillende uit lijst volgens gewichten
  function kiesDistinctGewogen(bron, k, gewichtMap) {
    const set = new Set();
    const list = [...bron];
    while (set.size < Math.min(k, list.length)) {
      let totaal = 0;
      for (const x of list) if (!set.has(x)) totaal += gewichtMap[x] || 1;
      let r = Math.random() * totaal;
      for (const x of list) {
        if (set.has(x)) continue;
        r -= (gewichtMap[x] || 1);
        if (r <= 0) { set.add(x); break; }
      }
    }
    return Array.from(set);
  }

  // stevige, hard gemaskeerde glans voor metaal
  function metallicOverlayMasked(w, h, isGoud, maskX, maskY, maskW, maskH) {
    const ov = document.createElement("canvas");
    ov.width = w; ov.height = h;
    const o = ov.getContext("2d");

    const lg = o.createLinearGradient(0, 0, 0, h);
    if (isGoud) {
      lg.addColorStop(0.00, "rgba(255,253,220,0.95)");
      lg.addColorStop(0.22, "rgba(255,255,255,0.35)");
      lg.addColorStop(0.55, "rgba(0,0,0,0.55)");
      lg.addColorStop(1.00, "rgba(110,80,0,0.45)");
    } else {
      lg.addColorStop(0.00, "rgba(255,255,255,0.95)");
      lg.addColorStop(0.40, "rgba(0,0,0,0.55)");
      lg.addColorStop(1.00, "rgba(235,235,235,0.50)");
    }
    o.fillStyle = lg; o.fillRect(0,0,w,h);

    o.save();
    o.translate(w/2, h/2); o.rotate(-Math.PI/8); o.translate(-w/2, -h/2);
    o.globalAlpha = 0.9;
    for (let i=0;i<4;i++) {
      const y0 = h*0.12 + i*h*0.22;
      const g = o.createLinearGradient(0, y0, w, y0);
      g.addColorStop(0, "rgba(255,255,255,0)");
      g.addColorStop(0.5, "rgba(255,255,255,1)");
      g.addColorStop(1, "rgba(255,255,255,0)");
      o.fillStyle = g; o.fillRect(0, y0 - h*0.06, w, h*0.12);
    }
    o.restore();

    const rg1 = o.createRadialGradient(w*0.22, h*0.18, 0, w*0.22, h*0.18, Math.max(w,h)*0.75);
    rg1.addColorStop(0, "rgba(255,255,255,1.00)");
    rg1.addColorStop(0.35, "rgba(255,255,255,0.65)");
    rg1.addColorStop(1, "rgba(255,255,255,0.00)");
    o.fillStyle = rg1; o.fillRect(0,0,w,h);

    const rg2 = o.createRadialGradient(w*0.78, h*0.82, 0, w*0.78, h*0.82, Math.max(w,h)*0.45);
    rg2.addColorStop(0, "rgba(255,255,255,0.85)");
    rg2.addColorStop(0.4, "rgba(255,255,255,0.45)");
    rg2.addColorStop(1, "rgba(255,255,255,0.00)");
    o.fillStyle = rg2; o.fillRect(0,0,w,h);

    // maskeren tot enkel het monster
    o.globalCompositeOperation = "destination-in";
    o.drawImage(imgMask, maskX, maskY, maskW, maskH);
    o.globalCompositeOperation = "source-over";
    return ov;
  }

  function renderCelTo(ctxMain, kleurNaam, rect, toonLabel) {
    const {x,y,w,h} = rect;
    const c = document.createElement("canvas");
    c.width = w; c.height = h;
    const cc = c.getContext("2d");

    // vulling
    cc.fillStyle = kleurMap[kleurNaam] || "#000";
    cc.fillRect(0, 0, w, h);

    // maskerplaatsing
    const r = Math.min(w / imgMask.width, h / imgMask.height);
    const mw = Math.round(imgMask.width * r);
    const mh = Math.round(imgMask.height * r);
    const mx = Math.round((w - mw)/2);
    const my = Math.round((h - mh)/2);

    // masker toepassen
    cc.globalCompositeOperation = "destination-in";
    cc.drawImage(imgMask, mx, my, mw, mh);
    cc.globalCompositeOperation = "source-over";

    // metaalglans
    if (metallic.has(kleurNaam)) {
      const ov = metallicOverlayMasked(w, h, kleurNaam==="Goud", mx, my, mw, mh);
      cc.save();
      cc.globalCompositeOperation = "multiply"; cc.globalAlpha = 0.95; cc.drawImage(ov, 0, 0);
      cc.globalCompositeOperation = "screen";   cc.globalAlpha = 0.95; cc.drawImage(ov, 0, 0);
      cc.globalCompositeOperation = "overlay";  cc.globalAlpha = 0.70; cc.drawImage(ov, 0, 0);
      cc.restore();
    }

    // lijnen
    if (witlijnen.has(kleurNaam)) {
      const tint = document.createElement("canvas");
      tint.width = mw; tint.height = mh;
      const tc = tint.getContext("2d");
      tc.fillStyle = "#ffffff"; tc.fillRect(0, 0, mw, mh);
      tc.globalCompositeOperation = "destination-in";
      tc.drawImage(imgLine, 0, 0, mw, mh);
      tc.globalCompositeOperation = "source-over";
      cc.drawImage(tint, mx, my);
    } else {
      cc.drawImage(imgLine, mx, my, mw, mh);
    }

    // naar kaart
    ctxMain.drawImage(c, x, y);

    // label optioneel
    if (toonLabel) {
      ctxMain.fillStyle = "#111";
      ctxMain.font = "bold 12px system-ui, Arial";
      ctxMain.textAlign = "center";
      ctxMain.fillText(kleurNaam, x + w/2, y + h - 6);
    }
  }

  // goud en zilver niet naast elkaar in 3 bij 3
  function plaats3x3(colors) {
    const posDiag = [[0,8],[2,6]]; // twee diagonalen
    const grid = Array(9).fill(null);
    const heeftG = colors.includes("Goud");
    const heeftZ = colors.includes("Zilver");
    const overig = colors.filter(k => k!=="Goud" && k!=="Zilver");
    if (heeftG && heeftZ) {
      const diag = posDiag[Math.floor(Math.random()*posDiag.length)];
      grid[diag[0]] = "Goud";
      grid[diag[1]] = "Zilver";
      shuffle(overig);
      let idx = 0;
      for (let i=0;i<9;i++) if (grid[i] === null) grid[i] = overig[idx++];
      return grid;
    }
    // anders willekeurig
    return shuffle([...colors]);
  }

  // bouw één set van 9 verschillende kleuren, vooral hoofdset
  function kies9Kleuren() {
    // zes uit de hoofdset, drie uit de extra set
    const gewHoofd = Object.fromEntries(hoofd.map(k => [k, 3]));
    const gewExtra = Object.fromEntries(extra.map(k => [k, 1]));
    const zes  = kiesDistinctGewogen(hoofd, 6, gewHoofd);
    const restKandidaten = extra.filter(k => !zes.includes(k));
    const drie = kiesDistinctGewogen(restKandidaten, 3, gewExtra);
    const negen = [...zes, ...drie];
    return negen;
  }

  // handtekening voor uniekheid
  function signatuur(arr){ return arr.join("|"); }

  // teken één kaart
  function tekenKaart(canvas, kleuren9, index, toonLabel) {
    const ctx = canvas.getContext("2d");
    const W = canvas.width = 600, H = canvas.height = 800;
    ctx.clearRect(0,0,W,H);

    // kader
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);
    ctx.lineWidth=6; ctx.strokeStyle="#222"; ctx.strokeRect(6,6,W-12,H-12);

    // titel
    ctx.fillStyle="#222"; ctx.font="bold 18px system-ui, Arial"; ctx.textAlign="left";
    ctx.fillText(`Kleuren Bingo kaart ${index+1}`, 16, 30);

    // raster 3 bij 3
    const pad = 14, gridX=16, gridY=44;
    const gridW = W - gridX*2, gridH = H - gridY - 16;
    const celW = Math.floor((gridW - pad*2)/3), celH = Math.floor((gridH - pad*2)/3);

    const rects = [];
    for (let r=0;r<3;r++){
      for (let c=0;c<3;c++){
        const x = gridX + c*(celW + pad);
        const y = gridY + r*(celH + pad);
        rects.push({x, y, w:celW, h:celH});
      }
    }

    // panelen
    ctx.lineWidth = 2; ctx.strokeStyle = "#222";
    rects.forEach(r => { ctx.beginPath(); ctx.roundRect(r.x, r.y, r.w, r.h, 12); ctx.fillStyle="#ffffff"; ctx.fill(); ctx.stroke(); });

    // monsters
    const volgorde = plaats3x3(kleuren9);
    for (let i=0;i<9;i++) {
      const r = rects[i];
      renderCelTo(ctx, volgorde[i], {x:r.x+8, y:r.y+8, w:r.w-16, h:r.h-16}, toonLabel);
    }
  }

  // bouw N unieke kaarten
  function bouwUniekeKaarten(n) {
    const set = new Set(), lijst = [];
    let tries = 0;
    while (lijst.length < n && tries < n * 400) {
      tries++;
      const k9 = kies9Kleuren();
      const arr = plaats3x3(k9);
      const sig = signatuur(arr);
      if (!set.has(sig)) { set.add(sig); lijst.push(arr); }
    }
    return lijst;
  }

  // ---------- UI ----------
  const grid = document.getElementById("grid");
  const status = document.getElementById("status");

  document.getElementById("gen").addEventListener("click", async () => {
    const n = Math.max(1, Math.min(50, parseInt(document.getElementById("aantal").value || "25", 10)));
    const toonLabel = document.getElementById("labelsToggle").checked;

    status.textContent = "Bezig met genereren…";
    await new Promise(r => setTimeout(r, 0));

    if (!assetsOK) {
      await Promise.all([
        new Promise(r => imgMask.complete ? r() : imgMask.onload = r),
        new Promise(r => imgLine.complete ? r() : imgLine.onload = r),
        new Promise(r => imgPupil.complete ? r() : imgPupil.onload = r)
      ]);
    }

    const pakket = bouwUniekeKaarten(n);
    grid.innerHTML = "";
    pakket.forEach((k9, idx) => {
      const wrap = document.createElement("div");
      wrap.className = "card";
      const h2 = document.createElement("h2");
      h2.textContent = `Kaart ${idx+1}`;
      const cnv = document.createElement("canvas");
      cnv.className = "cardcnv";
      const row = document.createElement("div"); row.className = "row";
      const dl = document.createElement("a"); dl.className="dl"; dl.href="#"; dl.textContent="Download PNG";
      dl.addEventListener("click", e => { e.preventDefault(); dl.href = cnv.toDataURL("image/png"); dl.download = `kaart-${idx+1}.png`; });
      wrap.appendChild(h2); wrap.appendChild(cnv); row.appendChild(dl); wrap.appendChild(row); grid.appendChild(wrap);
      tekenKaart(cnv, k9, idx, toonLabel);
    });

    status.textContent = `Klaar, ${pakket.length} unieke kaarten`;
  });

  document.getElementById("printBtn").addEventListener("click", () => window.print());
  </script>
</body>
</html>
